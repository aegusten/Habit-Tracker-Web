{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container py-4" style="max-width: 1000px;">
  <div class="text-center mb-4">
    <h2 class="fw-bold">Track Habit: <span class="text-primary">{{ habit.name }}</span></h2>
  </div>

  {% if messages %}
    <div class="alert-container position-fixed top-0 start-50 translate-middle-x mt-4" style="z-index: 1080;">
        {% for message in messages %}
        <div class="alert alert-success alert-dismissible fade show shadow border-0 rounded-3 px-4 py-3 d-flex align-items-center gap-2 text-sm" role="alert">
            <i class="bi bi-check-circle-fill fs-5"></i>
            <span>{{ message }}</span>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
  {% endif %}


  {% if streak >= 10 %}
  <div class="card text-center shadow-sm mb-3 p-3">
    <img src="{% static 'icons/streak_10.png' %}" alt="10-Day Streak" width="64">
    <h5 class="fw-bold mt-2">ðŸ“… 10-Day Streak</h5>
    <p class="text-muted small mb-0">Youâ€™ve logged 10 days in a row!</p>
  </div>
  {% endif %}

  {% if habit.template_key and habit.achieved %}
  <div class="card text-center shadow-sm mb-3 p-3">
    <img src="{% static 'icons/completed_preset.png' %}" alt="Completed Habit" width="64">
    <h5 class="fw-bold mt-2">âœ… Completed Prepared Habit</h5>
    <p class="text-muted small mb-0">Youâ€™ve completed a preset goal!</p>
  </div>
  {% endif %}

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card h-100 text-center p-3">
        <i class="bi bi-fire text-danger fs-2"></i>
        <h5 class="fw-semibold mt-2">Streak</h5>
        <p class="display-6 text-danger fw-bold">{{ streak }}</p>
        <small class="text-muted">Current Streak (days)</small>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100 text-center p-3">
        <i class="bi bi-trophy-fill text-success fs-2"></i>
        <h5 class="fw-semibold mt-2">Points</h5>
        <p class="display-6 text-success fw-bold">{{ total_points }}</p>
        <small class="text-muted">
          {% if badge %} Badge Earned: <strong>{{ badge }}</strong>
          {% else %} No Badge Earned Yet {% endif %}
        </small>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card h-100 text-center p-3">
        <i class="bi bi-hourglass-split text-warning fs-2"></i>
        <h5 class="fw-semibold mt-2">Upcoming Challenges</h5>
        <p class="display-6 text-warning fw-bold">{{ days_remaining }}</p>
        <small class="text-muted d-block">Days Remaining</small>
        <p class="mt-2">
          Next Badge:
          <strong class="text-primary">
            {% if total_points < 75 %}
              Silver (75 pts)
            {% elif total_points < 150 %}
              Gold (150 pts)
            {% else %}
              Platinum (Achieved)
            {% endif %}
          </strong>
        </p>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card h-100 p-3">
        <div class="d-flex align-items-center mb-2">
          <i class="bi bi-graph-up-arrow text-info fs-4 me-2"></i>
          <h5 class="fw-semibold mb-0">Insights</h5>
        </div>
        {% if not numeric_fields %}
            <div class="text-muted text-center">No numeric insights to display yet.</div>
        {% endif %}

        <div style="height: 200px;">
          <canvas id="habitChart"></canvas>
        </div>
        <small class="text-muted d-block mt-2">
          Committed Days: <strong>{{ committed_days }}</strong> | Days Left: <strong>{{ days_remaining }}</strong>
        </small>
        <a href="#" class="stretched-link" data-bs-toggle="modal" data-bs-target="#insightModal"></a>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3 h-100">
        <div class="d-flex align-items-center mb-2">
          <i class="bi bi-alarm text-danger fs-4 me-2"></i>
          <h5 class="fw-semibold mb-0">Reminder Settings</h5>
        </div>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="reminder">
            <div class="form-group mb-3">
              <label class="fw-semibold">Reminder Frequency</label>
              <select name="reminder_frequency" class="form-control rounded-3">
                <option value="daily" {% if habit.motivational_reminder == 'daily' %}selected{% endif %}>Daily</option>
                <option value="weekly" {% if habit.motivational_reminder == 'weekly' %}selected{% endif %}>Weekly</option>
              </select>
            </div>
            <button 
                type="submit" class="btn btn-outline-danger w-100">Update Reminder
            </button>
          </form>
          
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3 h-100">
        <div class="d-flex align-items-center mb-2">
          <i class="bi bi-flag-fill text-primary fs-4 me-2"></i>
          <h5 class="fw-semibold mb-0">Goal Timeline</h5>
        </div>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="timeline">
            <div class="form-group mb-3">
              <label class="fw-semibold">Goal Duration</label>
              <select name="timeline" class="form-control rounded-3">
                <option value="1" {% if habit.timeline == '1' %}selected{% endif %}>1 Month</option>
                <option value="2" {% if habit.timeline == '2' %}selected{% endif %}>2 Months</option>
              </select>
            </div>
            <button 
                type="submit" class="btn btn-outline-primary w-100">Update Goal
            </button>
          </form>
          
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const chartData = {{ chart_data|safe }};
    const labels = chartData.map(row => row.date);

    const datasets = [
        {% for field in numeric_fields %}
        {
            label: "{{ field|capfirst }}",
            data: chartData.map(row => row["{{ field }}"]),
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.2,
            fill: true
        },
        {% endfor %}
    ];

    const habitChartCanvas = document.getElementById('habitChart');
    if (habitChartCanvas) {
        const ctx = habitChartCanvas.getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    const customForm = document.getElementById("customDataForm");
    if (customForm) {
        customForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const inputs = document.querySelectorAll(".custom-data-input");
            const data = {};

            inputs.forEach(input => {
                const val = parseFloat(input.value);
                if (!isNaN(val)) {
                    data[input.name] = val;
                }
            });

            fetch("{% url 'habits:save_custom_data_api' habit.id %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(resp => {
                alert(resp.success ? "Data saved successfully!" : "Failed: " + resp.error);
            });
        });
    }

    const insightModal = document.getElementById('insightModal');
    if (insightModal) {
        insightModal.addEventListener('shown.bs.modal', () => {
            {% for field in numeric_fields %}
            const modalChart = document.getElementById('modalChart_{{ forloop.counter }}');
            if (modalChart) {
                new Chart(modalChart, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "{{ field|capfirst }}",
                            data: chartData.map(row => row["{{ field }}"]),
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: true
                        }]
                    }
                });
            }
            {% endfor %}
        });
    }

    // Auto-close Bootstrap alerts after 4 seconds
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
            bsAlert.close();
        });
    }, 4000);
});
</script>
    
{% endblock %}
