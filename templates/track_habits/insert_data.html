{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center">
    <h2 class="mb-0">Insert Data for Habit: {{ habit.name }}</h2>
    <button type="button" class="theme-toggle btn btn-light" id="themeToggle">
      <i class="bi bi-moon"></i>
    </button>
  </div>
  <hr class="mb-4">
  {% if habit.achieved %}
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        Habit Achieved
      </div>
      <div class="card-body">
        <p class="fw-bold text-primary">
          Congratulations! You completed this habit successfully.
        </p>
        <p class="text-muted">
          You no longer need to log data for this habit. Enjoy your achievement!
        </p>
      </div>
    </div>
  {% else %}
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        Daily Data Entry ({{ next_date|date:"F d, Y" }})
      </div>
      <div class="card-body">
        <form method="POST">
          {% csrf_token %}
          <h5 class="mb-3">Habit-Specific Fields</h5>
          {% for field_name, info in preset_fields %}
            <div class="mb-3">
              <label class="form-label">{{ info.label }} ({{ info.type }})</label>
              {% if info.type == "number" %}
                <input type="number" name="{{ field_name }}" class="form-control" placeholder="Enter number...">
              {% elif info.type == "time" %}
                <input type="time" name="{{ field_name }}" class="form-control">
              {% elif info.type == "date" %}
                <input type="date" name="{{ field_name }}" class="form-control">
              {% elif info.type == "yesno" %}
                <select name="{{ field_name }}" class="form-select">
                  <option value="">Select Yes/No</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              {% else %}
                <input type="text" name="{{ field_name }}" class="form-control" placeholder="Enter text...">
              {% endif %}
            </div>
          {% endfor %}
          <h5 class="mt-4 mb-3">Custom Fields</h5>
          {% for field_name, info in custom_fields %}
            <div class="mb-3">
              <label class="form-label">{{ info.label }} ({{ info.type }})</label>
              {% if info.type == "number" %}
                <input type="number" name="{{ field_name }}" class="form-control" placeholder="Enter number...">
              {% elif info.type == "time" %}
                <input type="time" name="{{ field_name }}" class="form-control">
              {% elif info.type == "date" %}
                <input type="date" name="{{ field_name }}" class="form-control">
              {% elif info.type == "yesno" %}
                <select name="{{ field_name }}" class="form-select">
                  <option value="">Select Yes/No</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              {% else %}
                <input type="text" name="{{ field_name }}" class="form-control" placeholder="Enter text...">
              {% endif %}
            </div>
          {% endfor %}
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      </div>
    </div>
  {% endif %}
  <h4>Previous Records</h4>
  {% if records %}
    <ul class="list-group">
      {% for rec in records %}
        <li class="list-group-item d-flex justify-content-between align-items-center record-item"
            data-date="{{ rec.date|date:'F d, Y' }}"
            data-json="{{ rec.data|safe }}"
            data-bs-toggle="modal"
            data-bs-target="#recordModal">
          <strong>{{ rec.date|date:"F d, Y" }}</strong>
          <small class="text-muted">{{ rec.data }}</small>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No records yet.</p>
  {% endif %}
  <div class="mt-3">
    <a href="{% url 'habits:track_habit_detail' habit.id %}" class="btn btn-secondary">Back to Habit Details</a>
  </div>
</div>

{% include 'track_habits/modal_record_details.html' %}

{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded',function(){
  document.querySelectorAll('.record-item').forEach(item=>{
    item.addEventListener('click',()=>{
      const dateStr=item.dataset.date;
      const rawJson=item.dataset.json||'{}';
      let parsed={};
      try{parsed=JSON.parse(rawJson.replace(/&quot;/g,'"'));}catch(e){}
      document.getElementById('recordModalLabel').textContent="Record Details ("+dateStr+")";
      let html='<table class="table table-sm">';
      for(let k in parsed){
        html+='<tr><th style="width:40%">'+k+'</th><td>'+parsed[k]+'</td></tr>';
      }
      html+='</table>';
      document.getElementById('recordModalBody').innerHTML=html;
    });
  });
  const themeToggle=document.getElementById('themeToggle');
  if(themeToggle){
    themeToggle.addEventListener('click',()=>{
      const body=document.body;
      const current=body.getAttribute('data-theme');
      if(current==='dark'){
        body.setAttribute('data-theme','light');
      } else {
        body.setAttribute('data-theme','dark');
      }
    });
  }
});
</script>
{% endblock %}
